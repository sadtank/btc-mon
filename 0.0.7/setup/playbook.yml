---
- name: Full Raspberry Pi setup for btcmon user
  hosts: localhost
  become: yes
  vars:
    btcmon_user: btcmon
    packages_install:
      - curl
      - dnsutils
      - git
      - iptables-persistent
      - i2c-tools
      - python3-evdev
      - python3-requests
      - python3-smbus
      #- rpi-eeprom
    services_to_disable:
      - cups
      - bluetooth
      - avahi-daemon
      - ModemManager
      - whoopsie
      - snapd
      - accounts-daemon
      - speech-dispatcher
      - triggerhappy
      - plymouth
    btcmon_service_path: /etc/systemd/system/btcmon.service
    btcmon_service_root: "/home/{{ btcmon_user }}/btc-mon"
    btcmon_service_exec: "{{ btcmon_service_root }}/current"
    btcmon_service_workdir: "{{ lookup('pipe', 'realpath ' + btcmon_service_exec) | dirname }}"
    

  tasks:
  # ---------------- Pin eprom ----------------
  #(for bookworm. trixie has an issue with eprom stuff...)
  #freezes firmware, but allows kernal updates
  #  - name: Pin EEPROM + bootloader firmware to prevent buggy updates
  #    ansible.builtin.copy:
  #      dest: /etc/apt/preferences.d/disable-rpi-firmware-upgrades
  #      mode: '0644'
  #      content: |
  #        Package: rpi-eeprom*
  #        Pin: release *
  #        Pin-Priority: -1

#          Package: raspberrypi-bootloader
#          Pin: release *
#          Pin-Priority: -1
  
    # ---------------- Remove APT lock files ----------------
    - name: Remove APT lock files if they exist
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/dpkg/lock-frontend
        - /var/cache/apt/archives/lock
      ignore_errors: yes

    # ---------------- Packages ----------------
    - name: Ensure required packages are installed
      apt:
        name: "{{ packages_install }}"
        state: present
        update_cache: yes

    # ---------------- Sudoers ----------------
    - name: Setup sudoers for unelevated commands
      copy:
        dest: /etc/sudoers.d/allow_scripted_commands
        content: |
          {{ btcmon_user }} ALL=(ALL) NOPASSWD: /usr/bin/timedatectl
          {{ btcmon_user }} ALL=(ALL) NOPASSWD: /usr/bin/raspi-config*
          Defaults:{{ btcmon_user }} !use_pty
          Defaults:{{ btcmon_user }} !logfile
        owner: root
        group: root
        mode: '0440'

    # ---------------- Timezone ----------------
    - name: Detect timezone from IP
      shell: curl -s --connect-timeout 10 -m 20 https://ipapi.co/timezone || echo "America/Los_Angeles"
      register: timezone
      ignore_errors: yes

    - name: Set timezone
      command: timedatectl set-timezone "{{ timezone.stdout }}"
      when: timezone.stdout != ""
      ignore_errors: yes

    - name: Fallback timezone if detection failed
      command: timedatectl set-timezone "America/Los_Angeles"
      when: timezone.stdout == "" or timezone.stdout is not defined

    # ---------------- I2C ----------------
    - name: Enable I2C using raspi-config
      command: raspi-config nonint do_i2c 0

    - name: Ensure i2c group exists
      group:
        name: i2c
        state: present

    - name: Add btcmon user to i2c group
      user:
        name: "{{ btcmon_user }}"
        groups: i2c
        append: yes

    - name: Load i2c-dev kernel module
      modprobe:
        name: i2c-dev
        state: present

    # ---------------- WiFi & Autologin ----------------
    #- name: Set WiFi country
    #  command: raspi-config nonint do_wifi_country "US"

    #- name: Set autologin
    #  command: raspi-config nonint do_boot_behaviour "B2"

    #- name: Disable Pi splash screen
    #  lineinfile:
    #    path: "/boot/config.txt"
    #    regexp: "^disable_splash="
    #    line: "disable_splash=1"
    #    state: present
    #    create: yes

    # ---------------- Firewall / iptables ----------------
    - name: Pre-answer debconf questions for iptables-persistent
      debconf:
        name: iptables-persistent
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: boolean
      loop:
        - { question: 'iptables-persistent/autosave_v4', value: true }
        - { question: 'iptables-persistent/autosave_v6', value: true }

    - name: Ensure iptables-persistent package is installed non-interactively
      apt:
        name: iptables-persistent
        state: present
        update_cache: yes

    - name: Setup iptables rules
      shell: |
        # Flush existing rules
        iptables -F
        iptables -X
        iptables -Z

        # Default policies
        iptables -P INPUT DROP
        iptables -P FORWARD DROP
        iptables -P OUTPUT DROP

        # Loopback
        iptables -A INPUT -i lo -j ACCEPT
        iptables -A OUTPUT -o lo -j ACCEPT

        # Established connections
        iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
        iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

        # http and https
        iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
        iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT

        # SSH
        iptables -A INPUT -p tcp --dport 22 -j ACCEPT
        iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT

        # DNS
        iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
        iptables -A INPUT -p udp --sport 53 -j ACCEPT

        # NTP
        iptables -A OUTPUT -p udp --dport 123 -j ACCEPT

        # ICMP ping
        iptables -A OUTPUT -p icmp --icmp-type 8 -j ACCEPT

    - name: Save iptables rules
      command: netfilter-persistent save

    - name: Restart apt-daily timers
      systemd:
        name: "{{ item }}"
        state: restarted
        masked: no
      loop:
        - apt-daily.service
        - apt-daily-upgrade.service

    # ---------------- Disable Services ----------------
    - name: Disable, stop, and mask unneeded services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
        masked: yes
      loop: "{{ services_to_disable }}"
      ignore_errors: yes  # Ignore if a service does not exist

    # ---------------- btcmon systemd Service ----------------
    - name: Create btcmon systemd service file
      copy:
        dest: "{{ btcmon_service_path }}"
        content: |
          [Unit]
          Description=btcmon LCD display service
          After=NetworkManager.service systemd-timesyncd
          Wants=NetworkManager.service systemd-timesyncd

          [Service]
          Type=simple
          User={{ btcmon_user }}
          WorkingDirectory={{ btcmon_service_workdir }}
          ExecStartPre=/bin/chvt 8
          ExecStart=/usr/bin/python3 {{ btcmon_service_exec }}

          StandardInput=tty
          StandardOutput=tty
          StandardError=tty
          TTYPath=/dev/tty8
          TTYReset=yes
          TTYVHangup=yes
          TTYVTDisallocate=yes
          SupplementaryGroups=input

          CapabilityBoundingSet=CAP_SYS_ADMIN CAP_SETUID CAP_SETGID CAP_SYS_TTY_CONFIG
          AmbientCapabilities=CAP_SYS_ADMIN CAP_SETUID CAP_SETGID CAP_SYS_TTY_CONFIG CAP_AUDIT_WRITE

          Restart=on-failure
          RestartSec=15

          Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'

    - name: Enable btcmon service to start on boot
      systemd:
        name: btcmon.service
        enabled: yes
        state: started

    # ---------------- OS & EEPROM Updates ----------------
    - name: Update all packages
      apt:
      #Commented because of pinning and eprom issues with upgrade
      #  upgrade: dist
        autoremove: yes
        autoclean: yes
        update_cache: yes

    #- name: Update Pi bootloader (EEPROM) to latest stable
    #  command: rpi-eeprom-update -d -a

    #- name: Ensure EEPROM is up-to-date
    #  become: yes
    #  command: rpi-eeprom-update -d -a
    #  register: eeprom_update
    #  failed_when: false
    #  changed_when: "'BOOTLOADER' in eeprom_update.stdout"  # Only mark as changed if update occurred
    #  ignore_errors: yes
    #  notify:
    #    - reboot

    #- name: Ensure EEPROM is up-to-date status
    #  debug:
    #    msg: "The EEPROM update status: {{ eeprom_update.stdout }}"



#------Minimize writes to SD card-------------
    # ---------------- fstab tweaks ----------------
    - name: Ensure root filesystem uses noatime
      lineinfile:
        path: /etc/fstab
        regexp: '^\s*(UUID|PARTUUID)=.*\s+/\s+ext4\s+'
        line: '\1 / ext4 defaults,noatime 0 1'
        backrefs: yes

    # ---------------- tmpfs mounts ----------------
    - name: Install /var/log tmpfs mount unit
      copy:
        dest: /etc/systemd/system/var-log.mount
        content: |
          [Unit]
          Description=Mount /var/log as tmpfs
          DefaultDependencies=no
          After=local-fs-pre.target
          Before=systemd-journald.service

          [Mount]
          What=tmpfs
          Where=/var/log
          Type=tmpfs
          Options=mode=0755,size=5M

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'

    - name: Ensure /var/log exists
      file:
        path: /var/log
        state: directory

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable and start /var/log tmpfs mount
      systemd:
        name: var-log.mount
        enabled: yes
        state: started


    # ---------------- Disable periodic writes ----------------
    
            
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes
        
        
    - name: Mask apt-daily timers
      systemd:
        name: "{{ item }}"
        masked: yes
        state: stopped
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer

    - name: Mask logrotate timer
      systemd:
        name: logrotate.timer
        masked: yes
        state: stopped
#--------------------------

    # ---------------- Expand root filesystem ----------------
    #ALREADY DONE BY FIRST BOOT.
#    - name: Expand root filesystem
#      command: raspi-config nonint do_expand_rootfs
#      register: expand_rootfs
#      changed_when: "'Root partition already expanded' not in expand_rootfs.stdout"
#      ignore_errors: yes  

    # ---------------- Final message ----------------
    - name: Notify user to reboot for changes to take effect
      debug:
        msg: |
          Setup is complete!

          To apply all changes (e.g., bootloader/EEPROM updates, splash screen, i2c group membership), 
          please reboot your Raspberry Pi manually:

              sudo reboot

